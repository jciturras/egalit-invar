---
title: "Preparación de datos"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
      number_sections: yes
    code_folding: hide
    number_sections: yes
editor_options:
  chunk_output_type: console
---

# Setup

```{r setup}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE, 
	fig.height = 18, 
	fig.width = 11, 
	cache = TRUE
)
options(scipen=9999) # desactivar notacion cientifica
remove(list = ls()) #limpieza del entorno de trabajo
```

```{css, echo=FALSE}
# /* expandir el espacio del documento*/
body .main-container {
      max-width: 1600px !important;
      width: 1600px !important;
    }
#/* expandir width de la TOC*/
div.tocify {
    width: 22% !important;
    max-width: 331px !important;
    max-height: 102% !important;
}
```

# Análisis descriptivo 

```{r tab-desc, results="asis", warning=FALSE}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra,
               summarytools,
               lavaan
               )
load(file = here::here("input/data-proc/study_1.RData"))

df_countries <- df_study %>% na.omit()
df_gender <- 
 df_countries %>% 
   select(starts_with("IS3G24"),
          country,
          country_name,
          educ_max,
          S_GENEQL)

  for (i in names(df_gender %>% select(IS3G24A,IS3G24B,IS3G24E))) {
    df_gender[[i]] <- sjmisc::rec(df_gender[[i]],rec = "rev")
  }

# CFA 2 dimension:.............................................................

# Evidence from previous analyses (Miranda & Castillo, 2018) indicates that the gender equality scale would consider up of two dimensions: support for equal political rights between men and women and attitudes towards the ability to participate in public space

cfa_gen2 <- '
  eqpol=~ IS3G24A+IS3G24B+IS3G24E
  eqpub=~ IS3G24C+IS3G24D+IS3G24F 
  '
fit_gen2 <- cfa(cfa_gen2,
                data = df_gender)

scores_gen2<- 
lavaan::lavPredict(fit_gen2) %>% 
  data.frame()
df_gender <- bind_cols(df_gender,scores_gen2)
# reescalar factor scores en 0 a 100
df_gender$eqpol_i<- scales::rescale(x =df_gender$eqpol,to = c(0, 100))
df_gender$eqpub_i<- scales::rescale(x =df_gender$eqpub,to = c(0, 100))
df_gender$educ_b <- ifelse(test = (df_gender$educ_max==4),
                           yes = "Terciaria o más",
                           no = "Menos de terciaria")

df_des <- select(df_gender,starts_with("IS3G24"),S_GENEQL,eqpol_i,eqpub_i,educ_b)
set_label(df_des$S_GENEQL) <- "Apoyo de los estudiantes a la igualdad de género (original)"
set_label(df_des$eqpol_i) <- "Puntaje factorial: Igualdad de derechos políticos" 
set_label(df_des$eqpub_i) <- "Puntaje factorial: Participar en el espacio público" 
set_label(df_des$educ_b) <- "Nivel educacional (Padres)"
labels <- get_label(df_des)

for (i in names(df_des %>% select(starts_with("IS3G24")))) {
  df_des[[i]] <- factor(df_des[[i]],levels = 1:4,labels = get_labels(df_gender$IS3G24A))
}

set_label(df_des) <- labels

# Css
st_css()
st_options(lang = "es",
           footnote = NA,
           bootstrap.css = F,
           custom.css = here::here("input/css/dfsummary.css")
           )

# Df variables nivel 1
df<- dfSummary(df_des,
               plain.ascii = FALSE,
               style = "grid",
               tmp.img.dir = "/tmp",
               graph.magnif = TRUE,
               headings = F,  # encabezado
               varnumbers = F, # num variable
               labels.col = T, # etiquetas
               na.col = F,    # missing
               graph.col = T, # plot
               valid.col = T, # n valido
               col.widths = c(700,10,10,10,10)
               )
df$Variable <- NULL # delete variable column
view(df,
     file = here::here("output/tables/desc01.html")
     ) # Ver tabla en un archivo HTML
webshot::webshot(url =here::here("output/tables/desc01.html"),
        file =here::here("output/tables/desc01.png")) # Remover archivo HTML
print(df, method = "render")
```


```{r tab-count, echo=FALSE}
#Tabla por países, escuelas y estudiantes
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra
               )
load(file = here::here("input/data-proc/study_1.RData"))

df_countries <- df_study %>% na.omit()
countries <- df_countries %>% group_by(country_name,IDSCHOOL) %>% summarise(count=n())
schools <- countries %>% group_by(country_name) %>% summarise(schools=n())
students <- df_countries %>% group_by(country_name) %>% summarise(students=n())

tab_countries <- left_join(schools,students)
tab_count <- 
tab_countries %>% 
  kable(col.names = c("País","Total de escuelas","Total de estudiantes"),
        booktabs = T,
        caption = "Muestra de países participantes en ICCS",
        format.args = list(big.mark = ".")) %>%
  kable_styling(full_width = F) %>% 
  footnote(general = paste0("Elaboración propia en base a datos de ICSS 2016","(N = ", 
                            format(dim(df_countries)[1], big.mark = "."),")"),
           general_title = "Nota: ",
           footnote_as_chunk = T,
           threeparttable = T)
tab_count
tab_count %>% cat(.,file = here::here("output/tables/tab_count.xls"))
```

```{r tab-gender}
# Tabla de variables: genero
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra
               )
load(file = here::here("input/data-proc/study_1.RData"))
df_countries <- df_study %>% na.omit()

df_gender <- 
df_countries %>% 
  select(starts_with("IS3G24")) %>% 
  get_label() %>% 
  data.frame()  
df_gender$items <- tolower(rownames(df_gender))
df_gender <- select(df_gender,items,".")
  
tab_gender <- 
  df_gender %>% 
  kable(col.names = c("Código ICCS","Apoyo de los estudiantes a la igualdad de género"),
        booktabs = T,
        row.names = F,
        caption = "Muestra de países participantes en ICCS") %>%
  kable_styling(full_width = F) %>% 
  footnote(general = paste0("Elaboración propia en base a datos de ICSS 2016. ","(N = ", 
                            format(dim(df_countries)[1], big.mark = "."),")",
  ". La escala de respuesta utilizada corresponde a (1) Muy de acuerdo; (2) De acuerdo; (3) En desacuerdo; (4) Totalmente en desacuerdo. ® Items invertidos"),
           general_title = "Nota: ",
           footnote_as_chunk = T,
           threeparttable = T)
tab_gender  
tab_gender %>% cat(.,file = here::here("output/tables/tab_gender.xls"))  
```

```{r cor-gender, fig.cap="Matriz de correlaciones policóricas para Apoyo de los estudiantes a la igualdad de género",fig.dim=c(8, 6)}
#Correlacion indicadores genero
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra, 
               lavaan
               )
load(file = here::here("input/data-proc/study_1.RData"))

df_countries <- df_study %>% na.omit()
df_gender <- 
 df_countries %>% 
   select(starts_with("IS3G24"))

for (i in names(df_countries %>% select(IS3G24A,IS3G24B,IS3G24E))) {
  df_countries[[i]] <- sjmisc::rec(df_countries[[i]],rec = "rev")
}

  # generate polychoric matrix
  cor_gender<- df_countries %>%
    dplyr::select(starts_with("IS3G24")) %>%
    lavaan::lavCor(., ordered=names(.))
  
  # cor_ci <- psych::corCi(df_countries %>% 
  #                          dplyr::select(starts_with("IS3G24")),
  #                        plot = F,poly = T)
  # 
  diag(cor_gender) = NA

  rownames(cor_gender) <-c(
      "A. Hombres/Mujeres igualdad en gobierno ®",
      "B. Hombres/Mujeres mismos derechos ®",
      "C. Mujeres permanecen fuera de la política",
      "D. Trabajo, prioridad para hombres",
      "E. Hombres/mujeres igualdad salarial ®",
      "F. Hombres mejores lideres políticos"
  )
  colnames(cor_gender) <-c("(A)", "(B)","(C)","(D)","(E)","(F)")

  corrplot::corrplot(cor_gender,
    method = "color",
    addCoef.col = "#000390",
    type = "upper",
    tl.col = "black",
    col=colorRampPalette(c("white","#0068DC"))(8),
    bg = "white",
    na.label = "-",
    order = "hclust")
```

```{r tab-nacion}
# Tabla de variables: actitud pais
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra
               )
load(file = here::here("input/data-proc/study_1.RData"))
df_countries <- df_study %>% na.omit()

df_country <- 
df_countries %>% 
  select(starts_with("IS3G27")) %>% 
  get_label() %>% 
  data.frame()  
df_country$items <- tolower(rownames(df_country))
df_country <- select(df_country,items,".")
  
  df_country %>% 
  kable(col.names = c("Código ICCS","Actitudes positivas de los estudiantes hacia su país de residencia"),
        booktabs = T,
        row.names = F,
        caption = "Muestra de países participantes en ICCS") %>%
  kable_styling(full_width = F) %>% 
  footnote(general = paste0("Elaboración propia en base a datos de ICSS 2016. ","(N = ", 
                            format(dim(df_countries)[1], big.mark = "."),")",
  ". La escala de respuesta utilizada corresponde a (1) Muy de acuerdo; (2) De acuerdo; (3) En desacuerdo; (4) Totalmente en desacuerdo."),
           general_title = "Nota: ",
           footnote_as_chunk = T,
           threeparttable = T)

```

```{r cor-nacion, fig.cap="Matriz de correlaciones policóricas para actitudes positivas de los estudiantes hacia su país de residencia",fig.dim=c(8, 6)}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra
               )
load(file = here::here("input/data-proc/study_1.RData"))
df_countries <- df_study %>% na.omit()

df_country <- 
df_countries %>% 
  select(starts_with("IS3G27"))

  # generate polychoric matrix
  cor_county<- df_countries %>%
    dplyr::select(starts_with("IS3G27")) %>%
    lavaan::lavCor(., ordered=names(.))
  
  diag(cor_county) = NA

  rownames(cor_county) <-c(
      "A. Bandera del país es importante",
      "B. Respeto hacia el país",
      "C. Orgullo por logros del país",
      "D. Orgullo vivir en país",
      "E. País mejor que otros países"
  )
  colnames(cor_county) <-c("(A)", "(B)","(C)","(D)","(E)")

  corrplot::corrplot(cor_county,
    method = "color",
    addCoef.col = "#000390",
    type = "upper",
    tl.col = "black",
    col=colorRampPalette(c("white","#0068DC"))(8),
    bg = "white",
    na.label = "-")
```

# Análisis multivariado

## Igualdad de género {-}

```{r cfa-genero}
# Analisis Factorial Confirmatorio: Genero
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra, 
               lavaan
               )
load(file = here::here("input/data-proc/study_1.RData"))

df_countries <- df_study %>% na.omit()
df_gender <- 
 df_countries %>% 
   select(starts_with("IS3G24"),country_name)

for (i in names(df_countries %>% select(IS3G24A,IS3G24B,IS3G24E))) {
  df_countries[[i]] <- sjmisc::rec(df_countries[[i]],rec = "rev")
}

names(df_gender)

# CFA 1 dimension:.............................................................

cfa_gen1 <- '
  eqgen=~ IS3G24A+IS3G24B+IS3G24C+IS3G24D+IS3G24E+IS3G24F
'
var_or <- c("IS3G24A","IS3G24B","IS3G24C","IS3G24D","IS3G24E","IS3G24F") 


fit_gen1 <- cfa(cfa_gen1,data = df_gender,
                group = "country_name",  #check
                ordered = var_or #check
                )

# lavaan::fitmeasures(fit_gen1)[c("chisq","df","cfi","tli","rmsea")]

# CFA 2 dimension:.............................................................

# Evidence from previous analyses (Miranda & Castillo, 2018) indicates that the gender equality scale would consider up of two dimensions: support for equal political rights between men and women and attitudes towards the ability to participate in public space

cfa_gen2 <- '
  eqpol=~ IS3G24A+IS3G24B+IS3G24E
  eqpub=~ IS3G24C+IS3G24D+IS3G24F 
  '
var_or <- c("IS3G24A","IS3G24B","IS3G24C","IS3G24D","IS3G24E","IS3G24F") 
fit_gen2 <- cfa(cfa_gen2,
                data = df_gender,
                group = "country_name", #check
                ordered = var_or #check                
                )

# lavaan::fitmeasures(fit_gen2)[c("chisq","df","cfi","tli","rmsea")]


  # extract fit indices from models and add to table
  sum_fit<- dplyr::bind_rows(lavaan::fitmeasures(fit_gen1)[c("chisq","df","cfi","tli","rmsea")],
                             lavaan::fitmeasures(fit_gen2)[c("chisq","df","cfi","tli","rmsea")])

  # Customize object
  sum_fit$mod <- c("1","2")
  sum_fit$nobs <- c(nobs(fit_gen1),nobs(fit_gen2))
  sum_fit$est <- c("ML","ML")
  sum_fit <- dplyr::select(sum_fit,mod,nobs,est,everything())
  colnames <- c("Dimensiones","$N$","Estimador","$\\chi^2$","gl","CFI","TLI","RMSEA")

  # Create table
  table_cfa_fits <-
    kable(
      sum_fit,
      # format=table_format,
      digits = 3,
      booktabs = T,
      col.names = colnames,
      caption = "Resumen de ajuste según número de dimensiones para modelo de medición de Igualdad de género ",
      escape = FALSE
    ) %>% 
    kable_styling(full_width = F,
                  font_size = 10,
                  latex_options = "HOLD_position",
                  bootstrap_options=c("striped", "bordered"))
  table_cfa_fits
 table_cfa_fits %>% cat(.,file = here::here("output/tables/tab_table_cfa_fits.xls"))
 
```

```{r cfa-gen1-count}
# Analisis Factorial Confirmatorio: Genero
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra, 
               lavaan
               )
load(file = here::here("input/data-proc/study_1.RData"))

df_countries <- df_study %>% na.omit()
df_gender <- 
 df_countries %>% 
   select(starts_with("IS3G24"),
          country,
          country_name)

for (i in names(df_gender %>% select(IS3G24A,IS3G24B,IS3G24E))) {
  df_gender[[i]] <- sjmisc::rec(df_gender[[i]],rec = "rev")
}

# CFA 1 dimension:.............................................................

cfa_gen1 <- '
  eqgen=~ IS3G24A+IS3G24B+IS3G24C+IS3G24D+IS3G24E+IS3G24F
'

# estimar modelo por paises
var_or <- c("IS3G24A","IS3G24B","IS3G24C","IS3G24D","IS3G24E","IS3G24F") 
df_paises <- split(df_gender, df_gender$country_name)
results = lapply(df_paises, function(df_gender) lavaan::cfa(cfa_gen1,data = df_gender,
                                                            ordered = var_or # check
                                                            ))

#extraer fitmeasures por paises
results_list<- lapply(results, function(results) data.frame(t(lavaan::fitmeasures(results)[c("chisq","df","cfi","tli","rmsea")])))
#extraer nobs por paises
nobs_list <- lapply(results, function(results) data.frame(obs=t(lavaan::nobs(results))))
nobs_n <- data.table::rbindlist(nobs_list) %>% 
  mutate(country=names(nobs_list)) %>%
  select(country,everything())

  # extract fit indices from models and add to table
  sum_fit <- 
  data.table::rbindlist(results_list) %>% 
  mutate(country=names(results_list)) %>% 
  select(country,everything())
  # Customize object
  sum_fit$nobs <- nobs_n$obs
  sum_fit <- dplyr::select(sum_fit,country,"chisq","df", nobs,"cfi","tli","rmsea")
  sum_fit <- sum_fit %>% dplyr::arrange(chisq)
  colnames <- c("País","$\\chi^2$","gl","$N$","CFI","TLI","RMSEA")
  # Create table
  tab_cfa_count_1d <-
    kable(
      sum_fit,
      # format=table_format,
      digits = 3,
      booktabs = T,
      col.names = colnames,
      caption = "Resumen de ajuste según países para modelo de medición de Igualdad de género (una dimensión)",
      escape = FALSE
    ) %>% 
    kable_styling(full_width = F,
                  font_size = 10,
                  latex_options = "HOLD_position",
                  bootstrap_options=c("striped", "bordered"))
  tab_cfa_count_1d
 tab_cfa_count_1d %>% 
   cat(.,file = here::here("output/tables/tab_cfa_count_1d.xls"))   
 sjmisc::frq(sum_fit$cfi>=0.95)
 sjmisc::frq(sum_fit$tli>=0.95)
 sjmisc::frq(sum_fit$rmsea<=0.06)
 
sjmisc::frq(sum_fit$cfi>=0.95 | sum_fit$tli>=0.95 | sum_fit$rmsea<=0.06)
```

```{r cfa-gen2-count}
# Analisis Factorial Confirmatorio: Genero
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra, 
               lavaan
               )
load(file = here::here("input/data-proc/study_1.RData"))

df_countries <- df_study %>% na.omit()
df_gender <- 
 df_countries %>% 
   select(starts_with("IS3G24"),
          country,
          country_name)

for (i in names(df_countries %>% select(IS3G24A,IS3G24B,IS3G24E))) {
  df_countries[[i]] <- sjmisc::rec(df_countries[[i]],rec = "rev")
}

# CFA 2 dimension:.............................................................

# Evidence from previous analyses (Miranda & Castillo, 2018) indicates that the gender equality scale would consider up of two dimensions: support for equal political rights between men and women and attitudes towards the ability to participate in public space

cfa_gen2 <- '
  eqpol=~ IS3G24A+IS3G24B+IS3G24E
  eqpub=~ IS3G24C+IS3G24D+IS3G24F 
  '

# estimar modelo por paises
var_or <- c("IS3G24A","IS3G24B","IS3G24C","IS3G24D","IS3G24E","IS3G24F") 
df_paises <- split(df_gender, df_gender$country_name)
results = lapply(df_paises, function(df_gender) lavaan::cfa(cfa_gen2,data = df_gender, 
                                                            ordered =var_or # check
                                                            ))

#extraer fitmeasures por paises
results_list<- lapply(results, function(results) data.frame(t(lavaan::fitmeasures(results)[c("chisq","df","cfi","tli","rmsea")])))
#extraer nobs por paises
nobs_list <- lapply(results, function(results) data.frame(obs=t(lavaan::nobs(results))))
nobs_n <- data.table::rbindlist(nobs_list) %>% 
  mutate(country=names(nobs_list)) %>%
  select(country,everything())

  # extract fit indices from models and add to table
  sum_fit <- 
  data.table::rbindlist(results_list) %>% 
  mutate(country=names(results_list)) %>% 
  select(country,everything())
  # Customize object
  sum_fit$nobs <- nobs_n$obs
  sum_fit <- dplyr::select(sum_fit,country,"chisq","df", nobs,"cfi","tli","rmsea")
  sum_fit <- sum_fit %>% dplyr::arrange(chisq)
  colnames <- c("País","$\\chi^2$","gl","$N$","CFI","TLI","RMSEA")
  
  # Create table
  tab_cfa_count_2d <-
    kable(
      sum_fit,
      # format=table_format,
      digits = 3,
      booktabs = T,
      col.names = colnames,
      caption = "Resumen de ajuste según países para modelo de medición de Igualdad de género (dos dimensiones)",
      escape = FALSE
    ) %>% 
    kable_styling(full_width = F,
                  font_size = 10,
                  latex_options = "HOLD_position",
                  bootstrap_options=c("striped", "bordered"))
  tab_cfa_count_2d 
 tab_cfa_count_2d %>% 
   cat(.,file = here::here("output/tables/tab_cfa_count_2d.xls"))  
 
 
 sjmisc::frq(sum_fit$cfi>=0.95)
 sjmisc::frq(sum_fit$tli>=0.95)
 sjmisc::frq(sum_fit$rmsea<=0.06)
```

```{r plots-fit, fig.dim= c(10, 4), fig.cap='Resumen de ajuste según países para modelo de medición de Igualdad de género (dos dimensiones)'}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra, 
               lavaan,
               ggplot2
               )
load(file = here::here("input/data-proc/study_1.RData"))

df_countries <- df_study %>% na.omit()
df_gender <- 
 df_countries %>% 
   select(starts_with("IS3G24"),
          country,
          country_name)

for (i in names(df_countries %>% select(IS3G24A,IS3G24B,IS3G24E))) {
  df_countries[[i]] <- sjmisc::rec(df_countries[[i]],rec = "rev")
}

# CFA 1 dimension:.............................................................

cfa_gen1 <- '
  eqgen=~ IS3G24A+IS3G24B+IS3G24C+IS3G24D+IS3G24E+IS3G24F
'

# estimar modelo por paises
var_or <- c("IS3G24A","IS3G24B","IS3G24C","IS3G24D","IS3G24E","IS3G24F") 
df_paises <- split(df_gender, df_gender$country_name)
results1 = lapply(df_paises, function(df_gender) lavaan::cfa(cfa_gen1,data = df_gender,ordered = var_or 
))

#extraer fitmeasures por paises
results1_list<- lapply(results1, function(results1) data.frame(t(lavaan::fitmeasures(results1)[c("chisq","df","cfi","tli","rmsea")])))
#extraer nobs por paises
nobs_list <- lapply(results1, function(results1) data.frame(obs=t(lavaan::nobs(results1))))
nobs_n <- data.table::rbindlist(nobs_list) %>% 
  mutate(country=names(nobs_list)) %>%
  select(country,everything())

  # extract fit indices from models and add to table
  sum_fit1 <- 
  data.table::rbindlist(results1_list) %>% 
  mutate(country=names(results1_list)) %>% 
  select(country,everything())
  # Customize object
  sum_fit1$nobs <- nobs_n$obs
  sum_fit1 <- dplyr::select(sum_fit1,country,"chisq","df", nobs,"cfi","tli","rmsea")
  
# CFA 2 dimension:.............................................................

cfa_gen2 <- '
  eqpol=~ IS3G24A+IS3G24B+IS3G24E
  eqpub=~ IS3G24C+IS3G24D+IS3G24F 
  '

# estimar modelo por paises
df_paises <- split(df_gender, df_gender$country_name)
results2 = lapply(df_paises, function(df_gender) lavaan::cfa(cfa_gen2,data = df_gender,ordered = var_or))

#extraer fitmeasures por paises
results2_list<- lapply(results2, function(results2) data.frame(t(lavaan::fitmeasures(results2)[c("chisq","df","cfi","tli","rmsea")])))
#extraer nobs por paises
nobs_list <- lapply(results2, function(results2) data.frame(obs=t(lavaan::nobs(results2))))
nobs_n <- data.table::rbindlist(nobs_list) %>% 
  mutate(country=names(nobs_list)) %>%
  select(country,everything())

  # extract fit indices from models and add to table
  sum_fit2 <- 
  data.table::rbindlist(results2_list) %>% 
  mutate(country=names(results2_list)) %>% 
  select(country,everything())
  # Customize object
  sum_fit2$nobs <- nobs_n$obs
  sum_fit2 <- dplyr::select(sum_fit2,country,"chisq","df", nobs,"cfi","tli","rmsea")
  
# fit_meas <- left_join(sum_fit1,sum_fit2, by = c("country"),suffix=c("_d1","_d2")) 
sum_fit1$dim <- 1
sum_fit2$dim <- 2

fit_meas <- bind_rows(sum_fit1,sum_fit2)
fit_meas$dim <- factor(fit_meas$dim,
                       levels = c(1,2), 
                       labels = c("Una","Dos"))

theme_set(theme_bw())
plot_chi<- plot_grpfrq(var.cnt = fit_meas$chisq,
                       var.grp=fit_meas$dim,
                       type = "boxplot",
                       ylim = c(0,5500),
                       title = "",
                       axis.titles = c("χ²"),
                       show.legend = F,
                       coord.flip = T) +
  scale_x_discrete(limits=rev, labels = c("Dos","Una"))

  
plot_cfi<- plot_grpfrq(var.cnt = fit_meas$cfi,  
                       var.grp=fit_meas$dim,
                       type = "boxplot",
                       ylim = c(0,1.5),
                       title = "CFI",                       
                       axis.titles = c(""),
                       show.legend = F, coord.flip = T) +
  scale_x_discrete(limits=rev, labels = c("Dos","Una")) + 
  geom_hline(yintercept=0.95, linetype="dashed", color = "grey")

plot_tli<- plot_grpfrq(var.cnt = fit_meas$tli,  
                       var.grp=fit_meas$dim,
                       type = "boxplot",
                       ylim = c(0,1.5),
                       title = "TLI",                       
                       axis.titles = c(""),
                       show.legend = F, coord.flip = T) +
  scale_x_discrete(limits=rev, labels = c("Dos","Una")) +
  geom_hline(yintercept=0.95, linetype="dashed", color = "grey")  
plot_rms<- plot_grpfrq(var.cnt = fit_meas$rmsea,
                       var.grp=fit_meas$dim,
                       type = "boxplot",
                       ylim = c(0,1.3),
                       title = "RMSEA",                       
                       axis.labels = c("Una","Dos"),
                       axis.titles = c(""),
                       show.legend = F, coord.flip = T) + 
  scale_x_discrete(limits=rev, labels = c("Dos","Una")) + 
  geom_hline(yintercept=0.05, linetype="dashed", color = "grey")  

plots_fit<- 
  gridExtra::grid.arrange(plot_cfi,plot_tli,plot_rms, ncol=1) 
```

```{r inv-genero}
# Analisis Factorial Confirmatorio: Genero
rm(list=ls())
options(knitr.kable.NA = '')
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra, 
               lavaan
               )
load(file = here::here("input/data-proc/study_1.RData"))

df_countries <- df_study %>% na.omit()
df_gender <- 
 df_countries %>% 
   select(starts_with("IS3G24"),
          country,
          country_name)

for (i in names(df_countries %>% select(IS3G24A,IS3G24B,IS3G24E))) {
  df_countries[[i]] <- sjmisc::rec(df_countries[[i]],rec = "rev")
}

# CFA 2 dimension:.............................................................

# Evidence from previous analyses (Miranda & Castillo, 2018) indicates that the gender equality scale would consider up of two dimensions: support for equal political rights between men and women and attitudes towards the ability to participate in public space

cfa_gen2 <- '
  eqpol=~ IS3G24A+IS3G24B+IS3G24E
  eqpub=~ IS3G24C+IS3G24D+IS3G24F 
  '

var_or <- c("IS3G24A","IS3G24B","IS3G24C","IS3G24D","IS3G24E","IS3G24F") 
  # inv01 <- semTools::measurementInvariance(model=cfa_gen2,
  #                                          data=df_gender,
  #                                          group="country",estimator = "ML",strict=TRUE,quiet = T)
  # inv02 <- semTools::measurementInvarianceCat(model=cfa_gen2,
  #                                             data=df_gender,
  #                                          group="country",estimator = "DWLS",
  #                                          strict=TRUE,quiet = T,ordered =var_or)
  # save(inv02, file = here::here("output/tables/invarianza_cat.RData"))

load(file = here::here("output/tables/invarianza_cat.RData"))
  
  # # configural invariance
  # fit.conf <- cfa(model=cfa_gen2,
  #                 data=df_gender,
  #                 group="country",estimator = "WLSMV",ordered = var_or)
  # 
  # # weak invariance
  # fit.load <- cfa(model=cfa_gen2,
  #                 data=df_gender,
  #                 group="country",estimator = "WLSMV",
  #                 group.equal = "loadings",ordered = var_or)
  # 
  # # strong invariance
  # fit.intercepts <- cfa(model=cfa_gen2,
  #                       data=df_gender,
  #                       group="country",estimator = "WLSMV",
  #                       group.equal = c("intercepts", "loadings"), 
  #                       ordered = var_or)
  # 
  # # strict invariance
  # fit.residuals <- cfa(model=cfa_gen2,
  #                       data=df_gender,
  #                       group="country",estimator = "WLSMV",
  #                       group.equal = c("intercepts", "loadings","residuals"), 
  #                       ordered = var_or)
  # 

  conf  <- inv02$fit.configural
  weak  <- inv02$fit.loadings
  strong<- inv02$fit.thresholds
  strict<- inv02$fit.residuals

  tab01<- lavaan::anova(conf,weak,strong,strict,SB.classic=TRUE) %>%
    dplyr::as_tibble() %>%
    dplyr::select("Chisq","Df","chisq_diff"=`Chisq diff`,"df_diff"=`Df diff`,"pvalue"=`Pr(>Chisq)`) %>%
    dplyr::mutate(stars=gtools::stars.pval(pvalue),
           chisqt=paste0(round(Chisq,2)," (",Df,") "),
           decision=ifelse(pvalue>0.05,yes = "Acepta",no = "Rechaza"),
           model=c("Configural","Débil","Fuerte","Estricta"))

  fit.meas <- dplyr::bind_rows(lavaan::fitmeasures(conf, output ="matrix")[c("chisq","df","cfi","rmsea","rmsea.ci.lower","rmsea.ci.upper"),],
                               lavaan::fitmeasures(weak, output ="matrix")[c("chisq","df","cfi","rmsea","rmsea.ci.lower","rmsea.ci.upper"),],
                               lavaan::fitmeasures(strong, output ="matrix")[c("chisq","df","cfi","rmsea","rmsea.ci.lower","rmsea.ci.upper"),],
                               lavaan::fitmeasures(strict, output ="matrix")[c("chisq","df","cfi","rmsea","rmsea.ci.lower","rmsea.ci.upper"),])

  # compute differences in chisq, df, cfi and rmsea (90%, lower.ci - upper.ci )
  fit.meas<- fit.meas %>%
    dplyr::mutate(diff.chi2 = chisq    - lag(chisq,default = dplyr::first(chisq)),
           diff.df   = df       - lag(df,   default = dplyr::first(df)),
           diff.cfi  = cfi      - lag(cfi,  default = dplyr::first(cfi)),
           diff.rmsea   = rmsea - lag(rmsea,default = dplyr::first(rmsea))) %>%
    round(3) %>%
    dplyr::mutate(rmsea.ci=paste0(rmsea," \n ", "(",rmsea.ci.lower,"-",rmsea.ci.upper,")"))

  tab.inv<- dplyr::bind_cols(tab01,fit.meas) %>%
    dplyr::select(model,chisqt,cfi,rmsea.ci,diff.chi2,diff.df,diff.cfi,diff.rmsea,stars,decision) %>%
    dplyr::mutate(diff.chi2=paste0(diff.chi2," (",diff.df,") ",stars)) %>%
    dplyr::select(model,chisqt,cfi,rmsea.ci,diff.chi2,diff.cfi,diff.rmsea,decision)

col.nam <- c("Model","$\\chi^2 (\\text{df})$","CFI","RMSEA (90 CI)",
               "$\\Delta \\chi^2 (\\Delta \\text{df}$)","$\\Delta \\text{CFI}$","$\\Delta \\text{RMSEA}$","Decisión")
  footnote <- paste0("***p < 0.001")

tab_inv_genero <-   
  knitr::kable(tab.inv, col.names = col.nam, align = "l",
        booktabs=TRUE,
        # format = table_format,
        escape = FALSE,
        caption = "Invarianza multigrupo para modelo de medición de Igualdad de género (dos dimensiones)") %>%
    kableExtra::kable_styling(full_width = FALSE,
                              latex_options = "HOLD_position",
                              bootstrap_options=c("striped", "bordered"),
                              font_size = 10) %>%
    kableExtra::footnote(general = footnote, footnote_as_chunk = T,general_title = "Nota: ")

  
tab_inv_genero  
tab_inv_genero %>% cat(.,file = here::here("output/tables/tab_inv_genero.xls")) 
```

* sort de tablas de fit meas por país y ordenar según x2
* revisar posibilidad de fuentes de invarianza x país
* son todos los países iguales en fit?

## Modelos

```{r tab-cor, eval=FALSE, cache=TRUE, include=FALSE}
# genero~educacion
options("mc.cores"=4) 
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra, 
               lavaan, ggplot2
               )
load(file = here::here("input/data-proc/study_1.RData"))

df_countries <- df_study %>% na.omit()
df_gender <- 
 df_countries %>% 
   select(starts_with("IS3G24"),
          country,
          country_name,
          educ_max,
          S_GENEQL)

  for (i in names(df_gender %>% select(IS3G24A,IS3G24B,IS3G24E))) {
    df_gender[[i]] <- sjmisc::rec(df_gender[[i]],rec = "rev")
  }

# CFA 1 y 2 dimension:.............................................................

# modelo 1 dimension
var_or <- c("IS3G24A","IS3G24B","IS3G24C","IS3G24D","IS3G24E","IS3G24F") 

cfa_gen1 <- '
  eqgen=~ IS3G24A+IS3G24B+IS3G24C+IS3G24D+IS3G24E+IS3G24F
'
# fit_gen1 <- cfa(cfa_gen1,
#                 data = df_gender,
#                 # ordered = var_or,
#                 group = "country_name",
#                 missing = "ML"                
#                 )

# modelo 2 dimensiones
var_or <- c("IS3G24A","IS3G24B","IS3G24C","IS3G24D","IS3G24E","IS3G24F") 

cfa_gen2 <- '
  eqpol=~ IS3G24A+IS3G24B+IS3G24E
  eqpub=~ IS3G24C+IS3G24D+IS3G24F 
  '
# fit_gen2 <- cfa(cfa_gen2,
#                 data = df_gender,
#                 # ordered = var_or,
#                 group = "country_name", 
#                 missing = "ML"
#                 )

# tictoc::tic()
# scores_gen1<-
# lavaan::lavPredict(fit_gen1,assemble = T,method = "EBM") %>%
#   data.frame()
# tictoc::toc() # 6.8 minutos

# summary(scores_gen1)

# save(scores_gen1,file = here::here("output/tables/scores_gen1.RData"))
load(file = here::here("output/tables/scores_gen1.RData"))

# tictoc::tic()
# scores_gen2<-
# lavaan::lavPredict(fit_gen2,assemble = T,method = "EBM") %>%
#   data.frame()
# tictoc::toc()

# summary(scores_gen2)

# save(scores_gen2,file = here::here("output/tables/scores_gen2.RData"))
load(file = here::here("output/tables/scores_gen2.RData"))

df_gender <- bind_cols(df_gender,
                       dplyr::select(scores_gen1,"eqgen"),                       
                       scores_gen2[,c("eqpol","eqpub")]
                       )

# estimar correlaciones por paises
df_paises <- split(df_gender %>% select(eqgen,eqpol,eqpub,educ_max), df_gender$country_name)

df_cor_mix = 
  lapply(df_paises, 
         function(df_paises)
           data.frame(t(psych::cor.ci(
             df_paises, poly = TRUE, plot = F
           )$rho[4, 1:3])))

df_cor_mix_p = 
  lapply(df_paises, 
         function(df_paises)
           data.frame(t(psych::cor.ci(
             df_paises, poly = TRUE, plot = F
           )$ci[c("eqgen-edc_m", "eqpol-edc_m", "eqpub-edc_m"), ]$p)))

df_corr <- 
data.table::rbindlist(df_cor_mix) %>% 
  mutate(country=names(df_cor_mix)) %>%
  select(country,everything())

df_pvalues <- 
data.table::rbindlist(df_cor_mix_p) %>% 
  mutate(country=names(df_cor_mix_p)) %>%
  select(country,everything()) %>% 
  rename(eqgen=X1,
         eqpol=X2,
         eqpub=X3)

cor_tab <- 
  left_join(df_corr,df_pvalues, by="country",suffix = c("_r","_p"))
cor_tab$eqgen <- paste0(round(cor_tab$eqgen_r,3),
                        gtools::stars.pval(cor_tab$eqgen_p))
cor_tab$eqpol <- paste0(round(cor_tab$eqpol_r,3),
                        gtools::stars.pval(cor_tab$eqpol_p))
cor_tab$eqpub <- paste0(round(cor_tab$eqpub_r,3),
                        gtools::stars.pval(cor_tab$eqpub_p))
cor_tab <- cor_tab %>% select(country,eqgen,eqpub,eqpol)

cor_tab %>% 
  kable(col.names = c("","Escala original",
                      "Participar en el espacio público", 
                      "Igualdad de derechos políticos"),
        caption = "Correlaciones polyseriales entre máximo nivel educacional alcanzado por los padres y los diferentes modelos de factores de
igualdad de género") %>% 
  kable_styling(full_width = F) %>% 
  footnote(general = paste0("Elaboración propia en base a datos de ICSS 2016. ","(N = ", 
                            format(dim(df_countries)[1], big.mark = "."),"). ", "$*p$ < 0.05 ;$**p$ < 0.01; $***p$ < 0.001"),
           general_title = "Nota: ",
           footnote_as_chunk = T,
           threeparttable = T) %>% 
    add_header_above(c(" " = 1, "Máximo nivel educacional alcanzado (padres)" = 3),align = "left") %>% 
    column_spec(2:4, width = "4cm")
```

```{r tab-lm-mean}
# genero~educacion
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos 
               knitr,
               kableExtra, 
               lavaan, ggplot2,tidymodels
               )
load(file = here::here("input/data-proc/study_1.RData"))

df_countries <- df_study %>% na.omit()
df_gender <- 
 df_countries %>% 
   select(starts_with("IS3G24"),
          country,
          country_name,
          educ_max,
          S_GENEQL)

  for (i in names(df_gender %>% select(IS3G24A,IS3G24B,IS3G24E))) {
    df_gender[[i]] <- sjmisc::rec(df_gender[[i]],rec = "rev")
  }

# CFA 1 y 2 dimension:.............................................................

# modelo 1 dimension
var_or <- c("IS3G24A","IS3G24B","IS3G24C","IS3G24D","IS3G24E","IS3G24F") 

cfa_gen1 <- '
  eqgen=~ IS3G24A+IS3G24B+IS3G24C+IS3G24D+IS3G24E+IS3G24F
'
# fit_gen1 <- cfa(cfa_gen1,
#                 data = df_gender, 
#                 ordered = var_or,
#                 group = "country_name"
#                 )

# modelo 2 dimensiones
var_or <- c("IS3G24A","IS3G24B","IS3G24C","IS3G24D","IS3G24E","IS3G24F") 

cfa_gen2 <- '
  eqpol=~ IS3G24A+IS3G24B+IS3G24E
  eqpub=~ IS3G24C+IS3G24D+IS3G24F 
  '
# fit_gen2 <- cfa(cfa_gen2,
#                 data = df_gender, 
#                 ordered = var_or,
#                 group = "country_name"
#                 )

# tictoc::tic()
# scores_gen1<- 
# lavaan::lavPredict(fit_gen1,assemble = T) %>% 
#   data.frame()
# tictoc::toc() # 6.8 minutos

#  save(scores_gen1,file = here::here("output/tables/scores_gen1.RData"))
load(file = here::here("output/tables/scores_gen1.RData"))
# tictoc::tic()
# scores_gen2<- 
# lavaan::lavPredict(fit_gen2,assemble = T) %>% 
#   data.frame()
# tictoc::toc()

# save(scores_gen2,file = here::here("output/tables/scores_gen2.RData"))
load(file = here::here("output/tables/scores_gen2.RData"))

df_gender <- bind_cols(df_gender,
                       dplyr::select(scores_gen1,"eqgen"),                       
                       scores_gen2[,c("eqpol","eqpub")]
                       )
df_paises <- split(df_gender, df_gender$country_name)
# reescalar factor scores en 0 a 100
df_gender$eqgen_i<- scales::rescale(x =df_gender$eqgen,to = c(0, 100))
df_gender$eqpol_i<- scales::rescale(x =df_gender$eqpol,to = c(0, 100))
df_gender$eqpub_i<- scales::rescale(x =df_gender$eqpub,to = c(0, 100))

# estimar regresiones por paises
df_gender$educ_b <- ifelse(test = (df_gender$educ_max==4),yes = 1,no = 0)
table(df_gender$educ_b)
sjmisc::frq(df_gender$educ_b)


# Modelos.......................
# use: https://dplyr.tidyverse.org/reference/group_map.html
df_lm_gen <- 
df_gender %>%
  group_by(country_name) %>%
  group_map(~ broom::tidy(lm(eqgen_i ~ educ_b, data = .x)),.keep = T)

df_lm_eqpol <- 
df_gender %>%
  group_by(country_name) %>%
  group_map(~ broom::tidy(lm(eqpol_i ~ educ_b, data = .x)),.keep = T)

df_lm_eqpub <- 
df_gender %>%
  group_by(country_name) %>%
  group_map(~ broom::tidy(lm(eqpub_i ~ educ_b, data = .x)),.keep = T)

# join resultados de modelos 
results_gen <- 
  data.table::rbindlist(df_lm_gen) %>% 
  select(term,estimate,p.value) %>% 
  filter(term=="educ_b") %>% 
  mutate(country=names(df_paises)) %>% 
  select(country,est_a=estimate,p_a=p.value)

results_eqpol <- 
  data.table::rbindlist(df_lm_eqpol) %>% 
  select(term,estimate,p.value) %>% 
  filter(term=="educ_b") %>% 
  mutate(country=names(df_paises)) %>% 
  select(country,est_b=estimate,p_b=p.value)
results_eqpub <- 
  data.table::rbindlist(df_lm_eqpub) %>% 
  select(term,estimate,p.value) %>% 
  filter(term=="educ_b") %>% 
  mutate(country=names(df_paises)) %>% 
  select(country,est_c=estimate,p_c=p.value)

# merge de datos con estimaciones............
lm_tab <- 
  left_join(results_gen,results_eqpol, by="country") %>% 
  left_join(results_eqpub, by="country")

lm_tab$eqgen    <- paste0(round(lm_tab$est_a,3),gtools::stars.pval(lm_tab$p_a))
lm_tab$eqpol    <- paste0(round(lm_tab$est_b,3),gtools::stars.pval(lm_tab$p_b))
lm_tab$eqpub    <- paste0(round(lm_tab$est_c,3),gtools::stars.pval(lm_tab$p_c))
lm_tab <- lm_tab %>% select(country,eqgen,eqpub,eqpol)


tab_mean_gender<- 
lm_tab %>% 
  kable(col.names = c("","Escala original",
                      "Participar en el espacio público", 
                      "Igualdad de derechos políticos"),
        caption = "Diferencias promedio entre estudiantes con y sin padres universitarios y los diferentes modelos de factores de
igualdad de género") %>% 
  kable_styling(full_width = F) %>% 
  footnote(general = paste0("Elaboración propia en base a datos de ICSS 2016. ","(N = ", 
                            format(dim(df_countries)[1], big.mark = "."),"). ", "$‘.’p$ < 0.10; $*p$ < 0.05 ;$**p$ < 0.01; $***p$ < 0.001"),
           general_title = "Nota: ",
           footnote_as_chunk = T,
           threeparttable = T) %>% 
    add_header_above(c(" " = 1, "Padres tienen/no tienen educación universitaria" = 3),align = "left") %>% 
    column_spec(2:4, width = "4cm")

tab_mean_gender
tab_mean_gender %>% cat(.,file = here::here("output/tables/tab_mean_gender.xls"))
```

```{r plot-bar-mean-gen-educ}
# genero~educacion
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra, 
               lavaan, ggplot2,tidymodels,
               tidyverse,
               ggh4x # para el facet anidado
               )
load(file = here::here("input/data-proc/study_1.RData"))

df_countries <- df_study %>% na.omit()
df_gender <- 
 df_countries %>% 
   select(starts_with("IS3G24"),
          country,
          country_name,
          educ_max,
          S_GENEQL)

  for (i in names(df_gender %>% select(IS3G24A,IS3G24B,IS3G24E))) {
    df_gender[[i]] <- sjmisc::rec(df_gender[[i]],rec = "rev")
  }

# CFA 1 y 2 dimension:.............................................................

# modelo 1 dimension
var_or <- c("IS3G24A","IS3G24B","IS3G24C","IS3G24D","IS3G24E","IS3G24F") 

cfa_gen1 <- '
  eqgen=~ IS3G24A+IS3G24B+IS3G24C+IS3G24D+IS3G24E+IS3G24F
'
# fit_gen1 <- cfa(cfa_gen1,
#                 data = df_gender, 
#                 ordered = var_or,
#                 group = "country_name"
#                 )

# modelo 2 dimensiones
var_or <- c("IS3G24A","IS3G24B","IS3G24C","IS3G24D","IS3G24E","IS3G24F") 

cfa_gen2 <- '
  eqpol=~ IS3G24A+IS3G24B+IS3G24E
  eqpub=~ IS3G24C+IS3G24D+IS3G24F 
  '
# fit_gen2 <- cfa(cfa_gen2,
#                 data = df_gender, 
#                 ordered = var_or,
#                 group = "country_name"
#                 )

# tictoc::tic()
# scores_gen1<- 
# lavaan::lavPredict(fit_gen1,assemble = T) %>% 
#   data.frame()
# tictoc::toc() # 6.8 minutos

#  save(scores_gen1,file = here::here("output/tables/scores_gen1.RData"))
load(file = here::here("output/tables/scores_gen1.RData"))
# tictoc::tic()
# scores_gen2<- 
# lavaan::lavPredict(fit_gen2,assemble = T) %>% 
#   data.frame()
# tictoc::toc()

# save(scores_gen2,file = here::here("output/tables/scores_gen2.RData"))
load(file = here::here("output/tables/scores_gen2.RData"))

df_gender <- bind_cols(df_gender,
                       dplyr::select(scores_gen1,"eqgen"),                       
                       scores_gen2[,c("eqpol","eqpub")]
                       )
df_paises <- split(df_gender, df_gender$country_name)
# reescalar factor scores en 0 a 100
df_gender$eqgen_i<- scales::rescale(x =df_gender$eqgen,to = c(0, 100))
df_gender$eqpub_i<- scales::rescale(x =df_gender$eqpub,to = c(0, 100))
df_gender$eqpol_i<- scales::rescale(x =df_gender$eqpol,to = c(0, 100))

# estimar regresiones por paises
df_gender$educ_b <- ifelse(test = (df_gender$educ_max==4),yes = 1,no = 0)
table(df_gender$educ_b)
sjmisc::frq(df_gender$educ_b)


# recode nombre de hong kong
df_gender$country_name[df_gender$country_name=="RAE de Hong Kong (China)"] <- "Hong Kong (RAE)"

df_long <- 
bind_rows(
df_gender %>% 
dplyr::select(id=country_name,var=eqgen_i,educ_b) %>% 
mutate(id2="1"),
df_gender %>% 
dplyr::select(id=country_name,var=eqpol_i,educ_b) %>% 
mutate(id2="2"),
df_gender %>% 
dplyr::select(id=country_name,var=eqpub_i,educ_b) %>% 
mutate(id2="3")
)

df_long$id2 <- factor(x = df_long$id2,
                           levels = 1:3,
                           labels = c("Original","D. Políticos","P. Público"))
# Plots........................................................................
theme_set(new = theme_bw() %+replace% 
            theme(axis.text = element_text(size = 13),
                  plot.title = element_text(size = 18,hjust = 0,vjust = 0.5),
                  axis.title.x = element_text(size = 15),
                  strip.text.x = element_text(size = 11)
                  )) 
mean_gender_by_var <- 
ggplot(df_long,aes(y=var, 
                   x=educ_b
                   ))+
  stat_summary(fun.y="mean", geom="point",
               # position="dodge"
               )+
  stat_summary(fun.data = mean_se, 
               geom = "errorbar", 
               # position="dodge",
               width=.8)+
  scale_x_continuous(breaks=c(0,1) ,labels = c("No \n Terc.", "Terc.")) +
  facet_nested_wrap(~id + id2,
             nrow = 3,
             # ncol = 6,
             # labeller =  label_wrap_gen(width = 10),
             ) + 
  xlab("Máximo nivel educacional alcanzado (padres)")+
  ylab(NULL)
# mean_gender_by_var
ggsave(plot = mean_gender_by_var,filename = "mean_gender_by_var.png",
       device = "png",units = "cm",width = 2.1,height = 1.1,scale = 30,
       path = "output/images")

mean_orig <- 
ggplot(df_gender,aes(y=eqgen_i, x=educ_b))+
  stat_summary(fun.y="mean", geom="point",position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", position="dodge",width=.8)+
  scale_x_continuous(breaks=c(0,1) ,labels = c("No \n Terc.", "Terc.")) +
  facet_wrap(~country_name,nrow = 3,labeller =  label_wrap_gen(width = 10)) +
  xlab("Máximo nivel educacional alcanzado (padres)")+
  ylab(NULL) +
  ggtitle("Escala original")

mean_eqpol <- 
ggplot(df_gender,aes(y=eqpol_i, x=educ_b))+
  stat_summary(fun.y="mean", geom="point",position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", position="dodge",width=.8)+
  # scale_y_continuous(limits = c(98,99))+
  scale_x_continuous(breaks=c(0,1) ,labels = c("No \n Terc.", "Terc.")) +
  facet_wrap(~country_name,nrow = 3,labeller =  label_wrap_gen(width = 10)) +
  xlab("Máximo nivel educacional alcanzado (padres)")+
  ylab(NULL) + 
  ggtitle(label = "Participar en el espacio público")

mean_eqpub <- 
ggplot(df_gender,aes(y=eqpub_i, x=educ_b))+
  stat_summary(fun.y="mean", geom="point",position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", position="dodge",width=.8)+
  # scale_y_continuous(limits = c(99,100))+
  scale_x_continuous(breaks=c(0,1) ,labels = c("No \n Terc.", "Terc.")) +
  facet_wrap(~country_name,nrow = 3,labeller =  label_wrap_gen(width = 10)) +
  xlab("Máximo nivel educacional alcanzado (padres)") + 
  ylab(NULL) +
  ggtitle("Igualdad de derechos políticos")  


# mean_gender<- 
#   gridExtra::grid.arrange(mean_orig,mean_eqpub, mean_eqpol, ncol=1) 
# ggsave(plot = mean_gender,filename = "mean_gender.png",
#        device = "png",units = "cm",width = 30,height = 45,
#        path = "output/images")

mean_gender2<- 
  gridExtra::grid.arrange(mean_orig,mean_eqpub, mean_eqpol, ncol=3) 
ggsave(plot = mean_gender2,filename = "mean_gender_h.png",
       device = "png",units = "cm",width = 2,height = 1.1,scale = 30,
       path = "output/images")
```

```{r plot-scatter-gen-educ, eval=FALSE, include=FALSE}
# genero~educacion
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               car,         # recodificar variables
               sjlabelled,  # etiquetado de variables
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               knitr,
               kableExtra, 
               lavaan,
               ggplot2
               )
load(file = here::here("input/data-proc/study_1.RData"))

df_countries <- df_study %>% na.omit()
df_gender <- 
 df_countries %>% 
   select(starts_with("IS3G24"),
          country,
          country_name,
          educ_max,
          S_GENEQL)

  for (i in names(df_gender %>% select(IS3G24A,IS3G24B,IS3G24E))) {
    df_gender[[i]] <- sjmisc::rec(df_gender[[i]],rec = "rev")
  }

# CFA 2 dimension:.............................................................
cfa_gen2 <- '
  eqpol=~ IS3G24A+IS3G24B+IS3G24E
  eqpub=~ IS3G24C+IS3G24D+IS3G24F 
  '
var_or <- c("IS3G24A","IS3G24B","IS3G24C","IS3G24D","IS3G24E","IS3G24F") 
fit_gen2 <- cfa(cfa_gen2,
                data = df_gender, ordered = var_or)
scores_gen2<- 
lavaan::lavPredict(fit_gen2) %>% 
  data.frame()
df_gender <- bind_cols(df_gender,scores_gen2)
# reescalar factor scores en 0 a 100
df_gender$eqpol_i<- scales::rescale(x =df_gender$eqpol,to = c(0, 100))
df_gender$eqpub_i<- scales::rescale(x =df_gender$eqpub,to = c(0, 100))
theme_set(theme_bw())
plot_orig <- 
ggplot(df_gender, aes(x = educ_max, y = S_GENEQL) ) +
  geom_smooth(method = "lm", se = TRUE,color="black") +
  # scale_y_continuous(limits = c(60,80)) +
  facet_wrap(~country_name,nrow = 3,labeller =  label_wrap_gen(width = 20)) +
  xlab("Máximo nivel educacional alcanzado (padres)")+
  ylab(NULL) +
  ggtitle("Escala original")

plot_eqpub <- 
ggplot(df_gender, aes(x = educ_max, y = eqpub_i)) +
  geom_smooth(method = "lm", se = TRUE,color="black") +
  # scale_y_continuous(limits = c(60,80))+
  facet_wrap(~country_name,nrow = 3,labeller =  label_wrap_gen(width = 20)) +
  xlab("Máximo nivel educacional alcanzado (padres)")+
  ylab(NULL) + 
  ggtitle(label = "Participar en el espacio público")

plot_eqpol <- 
ggplot(df_gender, aes(x = educ_max, y = eqpol_i) ) +
  geom_smooth(method = "lm", se = TRUE,color="black") +
  # scale_y_continuous(limits = c(60,80)) +
  facet_wrap(~country_name,nrow = 3, labeller =  label_wrap_gen(width = 20)) + 
  xlab("Máximo nivel educacional alcanzado (padres)") + 
  ylab(NULL) +
  ggtitle("Igualdad de derechos políticos")


plots_gender<- 
  gridExtra::grid.arrange(plot_orig,plot_eqpub, plot_eqpol, ncol=1) 
ggsave(plot = plots_gender,filename = "plots_gender.png",
       device = "png",units = "cm",width = 30,height = 45,
       path = "output/images")
```

- variable bruta iccs 
- variable latente original
- variable latente refinada
- correlación de 24 países actitude~educación, indicador compuesto S_HiSCED (polyserial corr)
- ttest 0 = menos de terciaria; 1 = terciaria o más





